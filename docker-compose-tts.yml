version: "3.8"

services:
  kyutai-tts:
    image: pytorch/pytorch:2.2.0-cuda12.1-runtime-ubuntu22.04
    working_dir: /app
    volumes:
      - /home/Ubuntu/kyutai-workspace/delayed-streams-modeling:/app
      - /home/Ubuntu/.cache/huggingface:/root/.cache/huggingface
    ports:
      - "8080:8080"
    environment:
      - CUDA_VISIBLE_DEVICES=0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
              count: 1
    command: >
      bash -c "
        cd /app &&
        pip install --no-cache-dir torch torchaudio &&
        pip install --no-cache-dir pydantic websockets msgpack &&
        pip install --no-cache-dir -e . &&
        /root/.cargo/bin/moshi-server worker --config configs/config-tts.toml
      "
    stdin_open: true
    tty: true
